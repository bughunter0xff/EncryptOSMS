<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SecureCrypt – UI (PHP-Compatible + DB Save) • Fallback</title>
  <script>
    // Load CryptoJS with fallbacks
    (function loadCryptoWithFallbacks(){
      function inject(src, onload){
        var s=document.createElement('script');
        s.src=src; s.async=false; s.onload=onload; s.onerror=onload;
        document.head.appendChild(s);
      }
      function afterAttempt(){
        if (window.CryptoJS) {
          document.dispatchEvent(new Event('cryptojs-ready'));
        } else if (!window.__cryptoTriedCdnjs) {
          window.__cryptoTriedCdnjs = true;
          inject('https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js', afterAttempt);
        } else {
          document.dispatchEvent(new Event('cryptojs-failed'));
        }
      }
      inject('https://unpkg.com/crypto-js@4.2.0/crypto-js.js', afterAttempt);
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .gradient-bg { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); min-height: 100vh; }
    .card-glass {
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      border: 1px solid rgba(209, 213, 219, 0.35);
    }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-backdrop.show { display: flex; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }
    .banner { padding:.5rem .75rem; border-radius:.5rem; margin:.5rem 0; }
  </style>
</head>
<body class="gradient-bg flex flex-col" data-endpoint="insert_encrypted.php">
  <header class="py-6 px-4 text-center">
    <h1 class="text-4xl font-bold text-white">SecureCrypt</h1>
    <p class="text-white/80">AES-256-CBC • PHP-Compatible • Save ciphertext to DB</p>
  </header>

  <main class="flex-grow px-4 py-8 flex items-center justify-center">
    <div class="w-full max-w-3xl card-glass p-6 md:p-8 shadow-xl">
      <div id="envBanner" class="banner bg-yellow-100 text-yellow-900 text-sm hidden"></div>
      <div id="libBanner" class="banner bg-red-100 text-red-700 text-sm hidden"></div>

      <div class="mb-6">
        <label for="inputText" class="block text-gray-800 font-semibold mb-2">
          <i class="fas fa-lock mr-2"></i>Enter plaintext to encrypt (or paste ciphertext to decrypt)
        </label>
        <div class="relative">
          <textarea id="inputText" rows="5" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none" placeholder="Type plaintext here, or paste Base64 ciphertext..."></textarea>
          <button id="clearInput" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600" title="Clear">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <button id="encryptBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg disabled:opacity-60" disabled>
          <i class="fas fa-lock mr-2"></i>Encrypt
        </button>
        <button id="decryptBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg disabled:opacity-60" disabled>
          <i class="fas fa-unlock mr-2"></i>Decrypt
        </button>
      </div>

      <div class="mb-2 flex items-center justify-between">
        <label for="outputText" class="block text-gray-800 font-semibold">
          <i class="fas fa-key mr-2"></i>Result
        </label>
        <div class="flex gap-2">
          <button id="copyOutput" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded">
            <i class="fas fa-copy mr-1"></i>Copy
          </button>
          <button id="openSaveModal" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded">
            <i class="fas fa-database mr-1"></i>Save to DB
          </button>
          <button id="toggleDiag" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded">
            <i class="fas fa-bug mr-1"></i>Diagnostics
          </button>
        </div>
      </div>
      <textarea id="outputText" rows="5" readonly class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 focus:outline-none"></textarea>

      <div id="diagnostics" class="mt-3 hidden text-sm text-gray-700">
        <div class="font-semibold mb-1">Diagnostics</div>
        <div id="diagContent" class="mono whitespace-pre-wrap"></div>
      </div>

      <div class="text-xs text-gray-600 mt-4">
        <span class="font-medium">Notes:</span>
        <ul class="list-disc ml-5">
          <li>Matches PHP: key/IV from SHA-256 hex (ASCII), key = first 32 bytes, IV = first 16 bytes.</li>
          <li>Decrypt auto-fixes double-Base64 ciphertext.</li>
          <li>Save to DB posts <span class="mono">{"ciphertext","label"}</span> JSON to your endpoint.</li>
        </ul>
        <div class="mt-1">Endpoint: <span id="epSpan" class="mono"></span></div>
      </div>
    </div>
  </main>

  <footer class="py-4 text-center text-white/80 text-sm">
    <p>&copy; 2025 SecureCrypt</p>
  </footer>

  <!-- Save Modal -->
  <div id="saveModal" class="modal-backdrop">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
          <i class="fas fa-database"></i> Save Encrypted Text
        </h2>
        <button id="closeSaveModal" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Label (optional)</label>
          <input id="metaLabel" type="text" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="e.g., Invoice #123" />
        </div>
        <p class="text-xs text-gray-500">Only the <strong>ciphertext</strong> is sent to your server.</p>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button id="cancelSave" class="px-4 py-2 rounded-lg border">Cancel</button>
        <button id="confirmSave" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
          <i class="fas fa-cloud-upload-alt mr-1"></i> Save
        </button>
      </div>
    </div>
  </div>

  <script>
    // Environment banner (warn if file://)
    (function(){
      const envBanner = document.getElementById('envBanner');
      if (location.protocol === 'file:') {
        envBanner.textContent = 'You opened this file via file:// — fetch() and CDN scripts may be blocked. Serve it from http:// or https:// (e.g., XAMPP/WAMP).';
        envBanner.classList.remove('hidden');
      }
    })();

    const epSpan = document.getElementById('epSpan');
    const endpoint = document.body.getAttribute('data-endpoint') || 'insert_encrypted.php';
    epSpan.textContent = endpoint;

    const inputText = document.getElementById('inputText');
    const outputText = document.getElementById('outputText');
    const encryptBtn = document.getElementById('encryptBtn');
    const decryptBtn = document.getElementById('decryptBtn');
    const copyOutput = document.getElementById('copyOutput');
    const clearInput = document.getElementById('clearInput');
    const openSaveModalBtn = document.getElementById('openSaveModal');
    const saveModal = document.getElementById('saveModal');
    const closeSaveModal = document.getElementById('closeSaveModal');
    const cancelSave = document.getElementById('cancelSave');
    const confirmSave = document.getElementById('confirmSave');
    const metaLabel = document.getElementById('metaLabel');
    const diagnostics = document.getElementById('diagnostics');
    const diagContent = document.getElementById('diagContent');
    const toggleDiag = document.getElementById('toggleDiag');
    const libBanner = document.getElementById('libBanner');

    function setDiag(msg) { diagContent.textContent = msg || ''; }
    function showAlert(message, type) {
      const existing = document.querySelector('.custom-alert');
      if (existing) existing.remove();
      const el = document.createElement('div');
      el.className = `custom-alert fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium flex items-center ${
        type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-yellow-500'
      }`;
      el.innerHTML = `<i class="fas ${ type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle' } mr-2"></i>${message}`;
      document.body.appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 0.5s ease'; setTimeout(() => el.remove(), 500); }, 3000);
    }

    // PHP-compatible key/iv (truncated hex-as-bytes)
    const SECRET_KEY = 'i85w/zdJrkU4o0GWj/0AIFJxOLuJDSmIl5f8TpN/16k=';
    const SECRET_IV  = '=k61/NpT8f5lImSDJuLOxJFIA0/jWG0o4UkrJdz/w58i';
    function phpDerivedKey() {
      const fullHex = CryptoJS.SHA256(SECRET_KEY).toString(CryptoJS.enc.Hex);
      const first32 = fullHex.substring(0, 32);
      return CryptoJS.enc.Utf8.parse(first32);
    }
    function phpDerivedIv() {
      const ivHex16 = CryptoJS.SHA256(SECRET_IV).toString(CryptoJS.enc.Hex).substring(0, 16);
      return CryptoJS.enc.Utf8.parse(ivHex16);
    }

    function isLikelyBase64(str) {
      return /^[A-Za-z0-9+/=]+$/.test(str) && (str.length % 4 === 0);
    }
    function tryAtob(s) { try { return atob(s); } catch { return null; } }
    function normalizeCiphertext(candidate) {
      let diag = [];
      diag.push('Input length: ' + candidate.length);
      if (!isLikelyBase64(candidate)) {
        diag.push('Input not Base64; using as-is.');
        return { fixed: candidate, diag: diag.join('\\n') };
      }
      const once = tryAtob(candidate);
      if (!once) {
        diag.push('Base64 decode failed; using as-is.');
        return { fixed: candidate, diag: diag.join('\\n') };
      }
      const looksB64 = isLikelyBase64(once.trim());
      diag.push('After 1 decode: length=' + once.length + ', looksBase64=' + looksB64);
      if (looksB64) {
        const twice = tryAtob(once.trim());
        if (twice) {
          diag.push('Double-Base64 detected -> using inner bytes.');
          const innerB64 = btoa(twice);
          return { fixed: innerB64, diag: diag.join('\\n') };
        }
      }
      diag.push('Using single-decoded/original Base64.');
      return { fixed: candidate, diag: diag.join('\\n') };
    }

    function encryptCompat(plain) {
      const key = phpDerivedKey();
      const iv  = phpDerivedIv();
      const ct = CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(plain), key, {
        iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7, keySize: 256/8
      });
      return ct.toString();
    }

    function decryptCompat(cipherMaybeWrapped) {
      const key = phpDerivedKey();
      const iv  = phpDerivedIv();
      const { fixed, diag } = normalizeCiphertext(cipherMaybeWrapped.trim());
      setDiag(diag);
      const out = CryptoJS.AES.decrypt(fixed, key, {
        iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7, keySize: 256/8
      });
      const txt = out.toString(CryptoJS.enc.Utf8);
      return txt || 'Error: Decryption failed - Invalid input or key';
    }

    function enableButtons() {
      encryptBtn.disabled = false;
      decryptBtn.disabled = false;
    }

    document.addEventListener('cryptojs-ready', () => {
      libBanner.classList.add('hidden');
      enableButtons();
    });
    document.addEventListener('cryptojs-failed', () => {
      libBanner.textContent = 'Failed to load CryptoJS from both CDNs. Please host crypto-js locally and include it, or check your internet/corporate firewall.';
      libBanner.classList.remove('hidden');
    });

    // UI events
    document.addEventListener('DOMContentLoaded', () => {
      toggleDiag.addEventListener('click', () => diagnostics.classList.toggle('hidden'));
      encryptBtn.addEventListener('click', () => {
        if (!window.CryptoJS) return showAlert('CryptoJS not loaded', 'error');
        const txt = inputText.value.trim();
        if (!txt) return showAlert('Please enter text to encrypt', 'error');
        setDiag('');
        outputText.value = encryptCompat(txt);
        showAlert('Encrypted!', 'success');
      });
      decryptBtn.addEventListener('click', () => {
        if (!window.CryptoJS) return showAlert('CryptoJS not loaded', 'error');
        const c = inputText.value.trim();
        if (!c) return showAlert('Paste ciphertext to decrypt', 'error');
        const res = decryptCompat(c);
        outputText.value = res;
        if (res.startsWith('Error')) showAlert(res, 'error'); else showAlert('Decrypted!', 'success');
      });
      copyOutput.addEventListener('click', () => {
        const v = outputText.value.trim();
        if (!v) return showAlert('Nothing to copy', 'warning');
        outputText.select(); document.execCommand('copy');
        showAlert('Copied to clipboard!', 'success');
      });
      clearInput.addEventListener('click', () => { inputText.value=''; inputText.focus(); });
      openSaveModalBtn.addEventListener('click', () => {
        if (!outputText.value.trim()) return showAlert('Nothing to save. Encrypt something first.', 'warning');
        saveModal.classList.add('show');
      });
      closeSaveModal.addEventListener('click', () => saveModal.classList.remove('show'));
      cancelSave.addEventListener('click', () => saveModal.classList.remove('show'));
      confirmSave.addEventListener('click', async () => {
        const ciphertext = outputText.value.trim();
        if (!ciphertext) return showAlert('Nothing to save.', 'warning');
        const label = (metaLabel.value || '').trim();
        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ciphertext, label })
          });
          let data; try { data = await res.json(); } catch { data = null; }
          if (res.ok && data && data.status === 'ok') {
            showAlert('Saved to database successfully!', 'success');
            saveModal.classList.remove('show'); metaLabel.value='';
          } else {
            let detail = (data && data.message) ? data.message : '';
            if (!detail) { try { detail = await res.text(); } catch {} }
            throw new Error((detail || 'Save failed') + (res.status ? ` (HTTP ${res.status})` : ''));
          }
        } catch (err) {
          console.error(err);
          showAlert('DB Save failed: ' + err.message, 'error');
        }
      });
    });
  </script>
</body>
</html>
